<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NAI ì´ë¯¸ì§€ ìë™ ë¶„ë¥˜ê¸° (Final v2)</title>
    <!-- JSZip ë¼ì´ë¸ŒëŸ¬ë¦¬ (í•„ìˆ˜) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        /* ì´ì „ ë””ìì¸ ìœ ì§€ */
        :root { --primary-color: #5c6bc0; --secondary-color: #eceff1; --success-color: #66bb6a; --error-color: #ef5350; --text-color: #37474f; --border-radius: 12px; }
        body { font-family: 'Pretendard', 'Malgun Gothic', sans-serif; line-height: 1.6; color: var(--text-color); background: #f0f2f5; margin: 0; padding: 30px 20px; }
        .container { max-width: 950px; margin: 0 auto; background: #fff; padding: 40px; border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: var(--primary-color); margin-bottom: 5px; letter-spacing: -1px; }
        .credit { text-align: center; font-size: 0.9em; color: #78909c; margin-bottom: 30px; }
        .guide-box { background: #e8eaf6; border: 1px solid #c5cae9; padding: 20px; border-radius: var(--border-radius); margin-bottom: 35px; font-size: 0.95em; color: #3f51b5; }
        .guide-box h3 { margin-top: 0; margin-bottom: 10px; } .guide-box ol { margin: 0; padding-left: 25px; } .guide-box li { margin-bottom: 8px; }
        .guide-highlight { font-weight: bold; color: #1a237e; background: #fff; padding: 2px 6px; border-radius: 4px; }
        h2 { border-left: 5px solid var(--primary-color); padding-left: 15px; margin-top: 40px; margin-bottom: 20px; color: #455a64; }
        .sub-text { font-size: 0.9em; color: #90a4ae; margin-bottom: 15px; }
        .rule-container { display: flex; flex-direction: column; gap: 12px; }
        .rule-row { display: flex; gap: 10px; align-items: flex-start; background: #fafafa; padding: 12px; border-radius: 8px; border: 1px solid #eee; }
        .rule-row textarea { flex-grow: 2; height: 50px; resize: vertical; border: 1px solid #cfd8dc; border-radius: 6px; padding: 10px; font-family: monospace; font-size: 0.95em; }
        .rule-row input.name-input { flex-grow: 1; border: 1px solid #cfd8dc; border-radius: 6px; padding: 10px; height: 50px; box-sizing: border-box; }
        .rule-row input.num-input { width: 70px; text-align: center; border: 1px solid #cfd8dc; border-radius: 6px; padding: 10px; height: 50px; box-sizing: border-box; font-weight: bold; }
        .btn { border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .btn-add { background: var(--success-color); color: white; padding: 10px 20px; margin-top: 12px; display: inline-flex; align-items: center; }
        .btn-add:hover { background: #43a047; transform: translateY(-2px); }
        .btn-del { background: var(--error-color); color: white; padding: 0 15px; height: 50px; font-size: 1.2em; }
        #drop-zone { border: 3px dashed #cfd8dc; border-radius: var(--border-radius); padding: 60px 30px; text-align: center; color: #b0bec5; background: #fafafa; transition: all 0.3s; cursor: pointer; }
        #drop-zone.dragover { border-color: var(--primary-color); background: #e8eaf6; color: var(--primary-color); }
        .drop-message { font-size: 1.3em; font-weight: bold; margin-bottom: 10px; }
        #file-input { display: none; }
        #action-section { text-align: center; margin-top: 30px; display: none; background: #f5f5f5; padding: 20px; border-radius: var(--border-radius); }
        #file-count-info { font-weight: bold; color: var(--primary-color); margin-bottom: 15px; }
        #start-btn { background: var(--primary-color); color: white; font-size: 1.3em; padding: 15px 50px; box-shadow: 0 4px 15px rgba(92, 107, 192, 0.3); }
        #start-btn:hover { background: #3f51b5; transform: translateY(-2px); }
        #start-btn:disabled { background: #b0bec5; cursor: not-allowed; transform: none; box-shadow: none; }
        .debug-label { display: inline-flex; align-items: center; background: #fff3e0; padding: 8px 15px; border-radius: 20px; border: 1px solid #ffe0b2; color: #e65100; font-size: 0.9em; cursor: pointer; }
        #progress-container { margin-top: 25px; display: none; }
        #progress-bar-wrapper { background: #eceff1; border-radius: 10px; overflow: hidden; height: 24px; }
        #progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, var(--primary-color), #7986cb); color: white; text-align: center; line-height: 24px; transition: width 0.3s; }
        #log-box { margin-top: 25px; height: 300px; overflow-y: auto; background: #263238; color: #eceff1; padding: 20px; border-radius: 8px; font-family: 'D2Coding', monospace; font-size: 0.9em; white-space: pre-wrap; word-break: break-all; box-shadow: inset 0 0 10px rgba(0,0,0,0.5); }
        .log-success { color: #66bb6a; } .log-error { color: #ef5350; }
        .log-debug { color: #ffd54f; font-weight: bold; border-bottom: 1px dashed #ffd54f; padding-bottom: 5px; margin: 15px 0 5px 0; display: block; }
        #download-section { text-align: center; margin-top: 40px; display: none; animation: popIn 0.5s; }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        .download-btn { display: inline-block; background: #ab47bc; color: white; padding: 18px 60px; text-decoration: none; border-radius: 50px; font-weight: bold; font-size: 1.4em; box-shadow: 0 5px 20px rgba(171, 71, 188, 0.4); transition: all 0.3s; }
        .download-btn:hover { background: #8e24aa; transform: translateY(-3px); box-shadow: 0 8px 25px rgba(171, 71, 188, 0.5); }
    </style>
</head>
<body>

<div class="container">
    <h1>NAI ì´ë¯¸ì§€ ìë™ ë¶„ë¥˜ê¸° (R2 ì—…ë¡œë“œìš©)</h1>

    <div class="guide-box">
        <h3>ğŸ“– ì‚¬ìš© ê°€ì´ë“œ</h3>
        <ol>
            <li><strong>ê·œì¹™ ì„¤ì •:</strong> ìºë¦­í„°ë³„ë¡œ, êµ¬ë¶„í•  í•µì‹¬ íƒœê·¸ë¥¼ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ ì ìœ¼ì„¸ìš”. ê·¸ í›„ ì˜†ì— ìºë¦­í„°ì˜ ì´ë¦„ì„ ì ìœ¼ì„¸ìš” (ì˜ˆ: <span class="guide-highlight"> navy blue hair, glitch, </span> | <span class="guide-highlight"> í•˜ì™€</span>). 2ë²ˆì—ëŠ” ìƒí™©ì„ êµ¬ë¶„í•  í•µì‹¬ íƒœê·¸ë¥¼ ì‰¼í‘œ(,)ë¡œ êµ¬ë¶„í•´ ì ìœ¼ì„¸ìš”. ê·¸ í›„ ì˜†ì— ëŒ€ì‘ë˜ëŠ” ìƒí™©ì„ ì ê³ , ì›í•˜ëŠ” ìˆ«ìì½”ë“œë¥¼ ì ìœ¼ì„¸ìš”.  (ì˜ˆ: <span class="guide-highlight"> glad, opened mouth, </span> | <span class="guide-highlight"> ê¸°ì¨ </span>|  <span class="guide-highlight"> 1 </span>)</li>
            <li><strong>ì£¼ì˜:</strong> ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(::, [], {})ëŠ” ë¬´ì‹œë©ë‹ˆë‹¤. ìˆœìˆ˜ ì•ŒíŒŒë²³ í‚¤ì›Œë“œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</li>
            <li><strong>ì´ë¯¸ì§€ íˆ¬í•˜ & ì‹¤í–‰:</strong> ì´ë¯¸ì§€ë¥¼ ë“œë˜ê·¸í•˜ê³  ì‹œì‘ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</li>
            <li>ì•ˆ ë˜ë©´ <strong>ğŸ” ë””ë²„ê·¸ ëª¨ë“œ</strong>ë¥¼ ì¼œì„œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ê·œì¹™ì„ ìˆ˜ì •í•˜ì„¸ìš”.</li>
        </ol>
    </div>

    <!-- [1] ì„¤ì • êµ¬ì—­: ìºë¦­í„° -->
    <div class="rule-section">
        <h2>1ï¸âƒ£ ìºë¦­í„° ì‹ë³„ ê·œì¹™ (ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ì ìš©)</h2>
        <div id="char-rules-container" class="rule-container"></div>
        <button class="btn btn-add" onclick="addCharRuleRow()">+ ìºë¦­í„° ìŠ¬ë¡¯ ì¶”ê°€</button>
    </div>

    <!-- [2] ì„¤ì • êµ¬ì—­: ê°ì •/ìƒí™© -->
    <div class="rule-section">
        <h2>2ï¸âƒ£ ê°ì •/ìƒí™© ì‹ë³„ ê·œì¹™ (ìœ„ì—ì„œë¶€í„° ìˆœì„œëŒ€ë¡œ ì ìš©)</h2>
        <div id="emotion-rules-container" class="rule-container"></div>
        <button class="btn btn-add" onclick="addEmotionRuleRow()">+ ê°ì •/ìƒí™© ìŠ¬ë¡¯ ì¶”ê°€</button>
    </div>

    <!-- [3] íŒŒì¼ ë“œë¡­ êµ¬ì—­ -->
    <h2>3ï¸âƒ£ ì´ë¯¸ì§€ íŒŒì¼ íˆ¬í•˜</h2>
    <div id="drop-zone">
        <p class="drop-message">ì—¬ê¸°ë¥¼ í´ë¦­í•˜ê±°ë‚˜, ì´ë¯¸ì§€ íŒŒì¼ë“¤ì„ ë“œë˜ê·¸í•˜ì„¸ìš”!</p>
        <input type="file" id="file-input" multiple accept="image/png">
    </div>

    <!-- ì‹¤í–‰ ë° ìƒíƒœ í‘œì‹œ -->
    <div id="action-section">
        <p id="file-count-info">ì¤€ë¹„ ì™„ë£Œ!</p>
        <label class="debug-label">
            <input type="checkbox" id="debug-mode-chk" checked>
            ğŸ” ë””ë²„ê·¸ ëª¨ë“œ (ì²´í¬ ê¶Œì¥: ë§¤ì¹­ì— ì‚¬ìš©ëœ ì‹¤ì œ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì¤ë‹ˆë‹¤)
        </label>
        <br><br>
        <button id="start-btn" class="btn" onclick="startProcessing()">âš¡ ì²˜ë¦¬ ì‹œì‘</button>
    </div>

    <div id="progress-container">
        <div id="progress-bar-wrapper"><div id="progress-bar">0%</div></div>
        <p id="progress-text" style="text-align: center; margin-top: 8px;">ëŒ€ê¸° ì¤‘...</p>
    </div>

    <div id="log-box">ë¡œê·¸ ëŒ€ê¸° ì¤‘... (ë””ë²„ê·¸ ëª¨ë“œê°€ ì¼œì ¸ ìˆìŠµë‹ˆë‹¤)</div>

    <div id="download-section">
        <p style="font-size: 1.2em; color: var(--success-color); font-weight: bold;">ğŸ‰ ì²˜ë¦¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</p>
        <a id="download-link" href="#" class="download-btn">ğŸ“¦ ZIP íŒŒì¼ ë‹¤ìš´ë¡œë“œ</a>
    </div>
</div>

<script>
    // ê¸°ë³¸ UI í•¨ìˆ˜ë“¤
    let selectedFiles = []; const logBox = document.getElementById('log-box'); const progressBar = document.getElementById('progress-bar'); const progressText = document.getElementById('progress-text'); const startBtn = document.getElementById('start-btn'); const debugCheckbox = document.getElementById('debug-mode-chk');
    function addLog(message, type = 'info') { const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' }); logBox.innerHTML += `<span class="log-${type}">[${time}] ${message}</span>\n`; logBox.scrollTop = logBox.scrollHeight; }
    function createDelButton() { const btn = document.createElement('button'); btn.className = 'btn btn-del'; btn.innerHTML = 'âœ–'; btn.onclick = function() { this.parentElement.remove(); }; return btn; }
    function addCharRuleRow(prompt = '', name = '') { const row = document.createElement('div'); row.className = 'rule-row'; row.innerHTML = `<textarea placeholder="êµ¬ë³„ í”„ë¡¬í”„íŠ¸ (ì˜ˆ: ivory hair, blue eyes)">${prompt}</textarea><input type="text" class="name-input" placeholder="ë¶€ì—¬í•  ì´ë¦„ (ì˜ˆ: ì´ë¦¬ë‚˜)" value="${name}">`; row.appendChild(createDelButton()); document.getElementById('char-rules-container').appendChild(row); }
    function addEmotionRuleRow(prompt = '', desc = '', num = '') { const row = document.createElement('div'); row.className = 'rule-row'; row.innerHTML = `<textarea placeholder="ìƒí™© í”„ë¡¬í”„íŠ¸ (ì˜ˆ: smile)">${prompt}</textarea><input type="text" class="name-input" placeholder="ì„¤ëª… (ì„ íƒ)" value="${desc}"><input type="text" class="num-input" placeholder="ìˆ«ì" value="${num}">`; row.appendChild(createDelButton()); document.getElementById('emotion-rules-container').appendChild(row); }
    window.onload = () => { addCharRuleRow('', ''); addEmotionRuleRow('', '', ''); };

    const dropZone = document.getElementById('drop-zone'); const fileInput = document.getElementById('file-input');
    dropZone.addEventListener('click', () => fileInput.click()); dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); }); dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover')); dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); handleFiles(e.dataTransfer.files); }); fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
    function handleFiles(files) { selectedFiles = Array.from(files).filter(f => f.type === 'image/png'); if (selectedFiles.length > 0) { document.getElementById('action-section').style.display = 'block'; document.getElementById('file-count-info').innerHTML = `ì´ <span style="color: var(--primary-color); font-size: 1.2em;">${selectedFiles.length}</span>ê°œì˜ PNG íŒŒì¼ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.`; addLog(`ğŸ“‚ ${selectedFiles.length}ê°œì˜ íŒŒì¼ì´ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info'); startBtn.disabled = false; document.getElementById('download-section').style.display = 'none'; } else { addLog('âš ï¸ PNG ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.', 'error'); } }

    // =========================================
    //  [ìµœì¢… ìˆ˜ì •] ì´ˆê°•ë ¥ í…ìŠ¤íŠ¸ ì„¸íƒê¸°
    //  JSON êµ¬ì¡°ë¥¼ ë¬´ì‹œí•˜ê³  ëª¨ë“  í…ìŠ¤íŠ¸ë¥¼ ê¸ì–´ëª¨ì€ ë’¤, ì•ŒíŒŒë²³ ì™¸ì—ëŠ” ì „ë¶€ ì œê±°í•©ë‹ˆë‹¤.
    // =========================================
    async function extractCleanPrompt(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const buffer = e.target.result; const dataView = new DataView(buffer); const decoder = new TextDecoder('utf-8');
                    let offset = 8; let rawMetadata = "";
                    // 1. PNG ì²­í¬ì—ì„œ í…ìŠ¤íŠ¸ ë°ì´í„° ë¬´ì‹í•˜ê²Œ ê¸ì–´ëª¨ìœ¼ê¸°
                    while (offset < buffer.byteLength) {
                        const length = dataView.getUint32(offset); const type = decoder.decode(buffer.slice(offset + 4, offset + 8));
                        if (type === 'tEXt' || type === 'iTXt') {
                            const textData = decoder.decode(buffer.slice(offset + 8, offset + 8 + length));
                            // NAI ê´€ë ¨ ë°ì´í„°ê°€ ë³´ì´ë©´ ì¼ë‹¨ ë‹¤ í•©ì¹¨
                            if (textData.includes('prompt') || textData.includes('Description') || textData.includes('{')) {
                                rawMetadata += textData + " ";
                            }
                        } offset += 12 + length;
                    }
                    if (!rawMetadata) { reject('NAI ë©”íƒ€ë°ì´í„° ì—†ìŒ'); return; }

                    // 2. [í•µì‹¬] ì´ˆê°•ë ¥ ì„¸íƒ: ì•ŒíŒŒë²³(a-z, A-Z)ê³¼ ê³µë°±ì„ ì œì™¸í•œ ëª¨ë“  ë¬¸ì(ìˆ«ì, ê¸°í˜¸) ì œê±°
                    // ì˜ˆ: "2::blue eyes::, -3 bad hands" -> "blue eyes bad hands"
                    const veryCleanText = rawMetadata.replace(/[^a-zA-Z\s]/g, ' ').replace(/\s+/g, ' ').trim().toLowerCase();
                    
                    resolve(veryCleanText);
                } catch (err) { reject('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜'); }
            };
            reader.readAsArrayBuffer(file);
        });
    }

    // ì‹¤í–‰ ë¡œì§
    async function startProcessing() {
        const charRules = []; document.querySelectorAll('#char-rules-container .rule-row').forEach(row => { const prompt = row.querySelector('textarea').value.trim().toLowerCase(); const name = row.querySelector('.name-input').value.trim(); if (prompt && name) charRules.push({ prompt, name }); });
        const emotionRules = []; document.querySelectorAll('#emotion-rules-container .rule-row').forEach(row => { const prompt = row.querySelector('textarea').value.trim().toLowerCase(); const num = row.querySelector('.num-input').value.trim(); if (prompt && num) emotionRules.push({ prompt, num }); });
        if (charRules.length === 0 || emotionRules.length === 0) { alert('ê·œì¹™ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        startBtn.disabled = true; document.getElementById('progress-container').style.display = 'block'; document.getElementById('download-section').style.display = 'none'; logBox.innerHTML = '';
        addLog('ğŸš€ ì²˜ë¦¬ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤...', 'info'); const zip = new JSZip(); let successCount = 0; const isDebug = debugCheckbox.checked;

        for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i]; progressText.textContent = `ì²˜ë¦¬ ì¤‘... (${i + 1} / ${selectedFiles.length})`;
            try {
                const cleanPrompt = await extractCleanPrompt(file);
                if (isDebug && i === 0) {
                     addLog(`\nğŸ” [ë””ë²„ê·¸] ì²« ë²ˆì§¸ íŒŒì¼ì˜ ìµœì¢… ì„¸íƒëœ ë°ì´í„°:\n(ì´ ì•ˆì— ê·œì¹™ ë‹¨ì–´ê°€ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)\n----------------------------------`, 'debug');
                     addLog(`${cleanPrompt}`, 'debug');
                     addLog(`----------------------------------\n`, 'debug');
                }
                const checkMatch = (rulePrompt, targetText) => rulePrompt.split(',').map(s => s.trim()).filter(s => s).every(part => targetText.includes(part));
                let matchedName = charRules.find(rule => checkMatch(rule.prompt, cleanPrompt))?.name;
                let matchedNum = emotionRules.find(rule => checkMatch(rule.prompt, cleanPrompt))?.num;

                if (matchedName && matchedNum) {
                    const newFileName = `${matchedName}${matchedNum}.png`; zip.file(newFileName, file);
                    addLog(`âœ… [ì„±ê³µ] ${file.name} â†’ ${newFileName}`, 'success'); successCount++;
                } else {
                    let failReason = []; if (!matchedName) failReason.push('ìºë¦­í„° ë¶ˆì¼ì¹˜'); if (!matchedNum) failReason.push('ê°ì • ë¶ˆì¼ì¹˜');
                    addLog(`âš ï¸ [ìŠ¤í‚µ] ${file.name} (${failReason.join(', ')})`, 'error');
                }
            } catch (error) { addLog(`âŒ [ì˜¤ë¥˜] ${file.name}: ${error}`, 'error'); }
            const percent = Math.round(((i + 1) / selectedFiles.length) * 100); progressBar.style.width = `${percent}%`; progressBar.textContent = `${percent}%`; await new Promise(resolve => setTimeout(resolve, 2));
        }
        progressText.textContent = 'ğŸ“¦ ZIP ì••ì¶• ì¤‘...';
        if (successCount > 0) {
            const blob = await zip.generateAsync({type: "blob"}); const downloadLink = document.getElementById('download-link');
            downloadLink.href = URL.createObjectURL(blob); downloadLink.download = `NAI_sorted_${new Date().getTime()}.zip`;
            document.getElementById('progress-container').style.display = 'none'; document.getElementById('download-section').style.display = 'block';
            addLog(`\nğŸ‰ ì™„ë£Œ! ì´ ${successCount}ê°œ ì„±ê³µ. ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.`, 'success');
        } else { progressText.textContent = 'ì‹¤íŒ¨'; addLog('\nâŒ ì„±ê³µí•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ë””ë²„ê·¸ ë¡œê·¸ë¥¼ í™•ì¸í•˜ê³  ê·œì¹™ì„ ìˆ˜ì •í•˜ì„¸ìš”.', 'error'); startBtn.disabled = false; }
    }
</script>
</body>
</html>